<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>View Â· GoDeep by DeepSight AI Labs</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon"/>
    <link href="static/css/camera_style.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://use.fontawesome.com/releases/v5.0.6/css/all.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link href="static/css/vxgplayer.css" rel="stylesheet" />
    <script type="text/javascript" src="lib/vxgplayer.js"></script>
    <script src="lib/highlight.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="lib/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="lib/jquery.blockUI.js"></script>

    <!-- TODO: Move PHP code to app.py -->
    <!-- <script>
            var floors = ['Favourites', 'All_Cameras'];
            var cameras = [];
            var alerts = [];
            var interval = 1000;
            var alertShowTime = 10000;
            var floor = 'All_Cameras';
            var audio = new Audio('alarm.mp3');
            var playStatus = {};
            var isHTTPStream = {};
            var inFullScreen = false;

            function playAlarm()
            {
                audio.addEventListener('ended', function()
                {
                    this.currentTime = 0;
                    this.play();
                }, false);
                audio.play();
            }

            function pauseAlarm()
            {
                audio.pause();
            }

            function onLoad()
            {
                if (!checkLicenseValidity())
                {
                    return;
                }

                $.ajax(
                {
                    url: 'load.php',
                    type: 'POST',
                    data:
                    {
                        reqMethod: 'getBackground'
                    },
                    dataType: "json",
                    success: function(response)
                    {
                        console.log("Response");
                        console.log(response);
                        var bg_img = "url('img/" + response['image'] + "')";
                        document.getElementById('main').style.backgroundImage = bg_img;
                        $('#select').val(response['image']);
                    },
                    error: function()
                    {
                        // alert("Failed establishing communication with the server");
                        window.location = "home";
                    }
                });

                $.ajax(
                {
                    url: 'load.php',
                    type: 'POST',
                    data:
                    {
                        reqMethod: 'getAllCameras'
                    },
                    dataType: "json",
                    success: function(response)
                    {
                        console.log("Response");
                        cameras = response;
                        recordsTableData(response);
                    },
                    error: function()
                    {
                        // alert("Failed establishing communication with the server");
                        window.location = "home";
                    }
                });
            }

            function checkLicenseValidity()
            {
                var ret = false;
                console.log("Checking license validity");
                $.ajax(
                {
                    url: 'load.php',
                    type: 'POST',
                    data:
                    {
                        reqMethod: 'getLicenseValidity'
                    },
                    dataType: "json",
                    async: false,
                    success: function(response)
                    {
                        console.log(response);
                        ret = response["status"];
                        if (!ret)
                        {
                            alert(response["reason"]);
                            window.location = "home";
                        }
                    },
                    error: function()
                    {
                        // alert("Failed establishing communication with the server");
                        window.location = "home";
                    }
                });

                return ret;
            }

            function recordsTableData(result)
            {
                console.log(result)

                // Add Floors
                let checkFilter = "";
                $.each(result, function(key, val)
                {
                    var floor = val['floor'];
                    if ((floors.indexOf(floor) > -1))
                    {
                        console.log("Floor Found");
                    }
                    else
                    {
                        floors.push(floor);        
                    }

                    // Add Cameras
                    addVideoView(key, val);
                    addCameraView(key, val['http_url']);

                    if (!(key in playStatus))
                    {
                        playStatus[key] = false;
                    }
                    else
                    {
                        if (playStatus[key])
                        {
                            hidePlayButton(key);
                        }
                    }
                });


                for (var i = 0; i < floors.length; i++)
                {
                    checkFilter += "<li onclick='onListSelect(" + floors[i] + ")' class='main_li_view' id='" + floors[i] + "'>" + floors[i] + "</li>";
                }

                $('#filters').append(checkFilter);
                $('#contentTitle').text("All_Cameras");
                $(".maim_ul_view li#All_Cameras").addClass("active");

                $('.maim_ul_view li').click(function()
                {
                    $('li').removeClass("active");
                    $(this).addClass("active");
                });
            };

            function changeBackgroundImage()
            {
                var img = document.getElementById('select').value;
                var bg_img = "url('static/img/" + img + "')";
                document.getElementById('main').style.backgroundImage = bg_img;
                saveBackgroundImage(img);
            }

            function saveBackgroundImage(img)
            {
                var data = {};
                data['image'] = img;
                console.log(data);
                var jsondata = JSON.stringify(data);
                console.log(jsondata);
                $.ajax(
                {
                    url: 'load.php',
                    type: 'POST',
                    data:
                    {
                        reqMethod: 'sendBackground',
                        data: jsondata
                    },
                    dataType: "json",
                    success: function(response)
                    {
                        console.log("Response<br/>");
                        console.log(response);
                    },
                    error: function()
                    {
                        // alert("Failed establishing communication with the server");
                        window.location = "home";
                    }
                });
            }

            function showFilteredCameras(floor)
            {
                $.each(cameras, function (key, val)
                {
                    if (vxgplayer('mr_media_player' + key) != undefined)
                    {                    
                        vxgplayer('mr_media_player' + key).dispose();
                    }
                });

                $('#viewVideo').empty();

                $.each(cameras, function(key, val)
                {
                    if (floor == 'All_Cameras')
                    {
                        addVideoView(key, val);
                        addCameraView(key, val['http_url']);
                    }
                    else if (floor == 'Favourites')
                    {
                        if (val['favourite'])
                        {
                            addVideoView(key, val);
                            addCameraView(key, val['http_url']);
                        }
                    }
                    else
                    {
                        if (val['floor'] == floor)
                        {
                            addVideoView(key, val);
                            addCameraView(key, val['http_url']);
                        }
                    }

                    if (isHTTPStream[key])
                    {
                       if (playStatus[key])
                        {
                            hidePlayButton(key);
                        } 
                    }                        
                });
            }

            function addCameraView(key, url) 
            {
                if (isHTTPStream[key]) { return; }

                var playerId = 'mr_media_player' + key;
                vxgplayer(playerId, 
                {
                    url: '',
                    nmf_path: 'media_player.nmf',
                    nmf_src: 'pnacl/Release/media_player.nmf',
                    latency: 10000,
                    aspect_ratio_mode: 1,
                    autohide: 3,
                    controls: true,
                    avsync: false,
                    autoreconnect: 1,
                    width: 270,
                    height: 152,
                    margin: 0,
                }).ready(function () 
                {
                    console.log('=> Ready Player ' + playerId);
                    vxgplayer(playerId).src(url);
                    // vxgplayer(playerId).play();                
                    console.log('<= Ready Player ' + playerId);
                });
            }

            function addVideoView(key, val)
            {
                if (!(key in isHTTPStream))
                {
                    isHTTPStream[key] = val['http_url'].startsWith("http");
                }

                if (isHTTPStream[key])
                {
                    console.log("HTTP Stream");

                    var addVideoDiv = "<div class=' col-lg-4 col-md-6 col-sm-6 col-xs-12 video_container' data-id='af' data-category='all fav' id='cview" + key + "'>" +
                    "<div class='video_shado'>" +
                    "<i id='csview_status" + key + "' class='fa fa-circle video_icon'></i>" +
                    "<div id='mr_media_player" + key + "' class='vxgplayer video_frame'>" + 
                    "<img id='httpStream" + key + "' class='video_frame' src='img/image.jpg'></div>" +                     
                    "<p hidden id='httpLink" + key + "'>" + val['http_url'] + "</p>" +  
                    "<p class='p_video_change' id='csview_text" + key + "'>" + val['camera_name'] + " &nbsp" + 
                    "<i id='fullScreenBtn" + key + "' onclick='showFullScreen(" + key + ")' class='fa fa-expand playerIcon fullScreenIcon' aria-hidden='true'></i>" + 
                    "<i id='pauseBtn" + key + "' onclick='pauseButton(" + key + ")' class='fa fa-pause playerIcon pauseIcon' aria-hidden='true'></i>" +
                    "<i id='fav" + key + "' onclick='favChange(" + key + ")' class='fa fa-star playerIcon favOff' aria-hidden='true'></i>" + 
                    "</p>" +
                    "<button id='playBtn" + key + "' name='Comanda' onclick='hidePlayButton(" + key + ")' class='play_video'><i id='hideIcon" + key + "' name='Comanda' class='far fa-play-circle fa-lg camera_play_icon'></i></button>" +
                    "</div>" +
                    "</div>";
                }

                else
                {
                    console.log("RTSP Stream");

                    var addVideoDiv = "<div class=' col-lg-4 col-md-6 col-sm-6 col-xs-12 video_container' data-id='af' data-category='all fav' id='cview" + key + "'>" +
                    "<div class='video_shado'>" +
                    "<i id='csview_status" + key + "' class='fa fa-circle video_icon'></i>" +
                    "<div id='mr_media_player" + key + "' class='vxgplayer video_frame'></div>" +
                    "<img id='hideImg" + key + "' class='video_frame' src='img/image.jpg'>" +
                    "<p class='p_video_change' id='csview_text" + key + "'>" + val['camera_name'] + " &nbsp<i id='fav" + key + "' onclick='favChange(" + key + ")' class='fa fa-star playerIcon favOff' aria-hidden='true'></i></p>" +
                    "<button id='hideBtn" + key + "' name='Comanda' onclick='hidePlayButton(" + key + ")' class='play_video'><i id='hideIcon" + key + "' name='Comanda' class='far fa-play-circle fa-lg camera_play_icon'></i></button>" +
                    "</div>" +
                    "</div>";
                }
                
                console.log(addVideoDiv);

                $('#viewVideo').append(addVideoDiv);
                $('#csview_status' + key).hide();

                if (isHTTPStream[key])
                {
                    $('#pauseBtn' + key).hide();
                    $('#fullScreenBtn' + key).hide();
                }

                if (val['favourite'] == 1)
                {
                    $('#fav' + key).removeClass('favOff');
                    $('#fav' + key).addClass('favOn');
                }
            }

            function hidePlayButton(key) 
            {
                if (isHTTPStream[key])
                {
                    $('#playBtn' + key).hide();
                    $('#pauseBtn' + key).fadeIn(500);
                    $('#fullScreenBtn' + key).fadeIn(500);
                    //$('#httpStream' + key).attr('src', $('#httpLink' + key).text());

                    $('#httpStream' + key).fadeOut(500, function() 
                    {
                        $('#httpStream' + key).attr('src', $('#httpLink' + key).text());
                    }.bind(this)).fadeIn(6000);

                    playStatus[key] = true;
                }

                else
                {
                    $('#hideImg' + key).hide();
                    $('#hideBtn' + key).hide();
                    $('#hideIcon' + key).hide();

                    //Play video
                    var playerId = 'mr_media_player' + key;          
                    vxgplayer(playerId).play();
                    console.log(vxgplayer(playerId));
                    
                    vxgplayer(playerId).stopButton().addEventListener("click", function()
                    {
                        console.log("showPlayButton",key);
                        $('#hideImg' + key).show();
                        $('#hideBtn' + key).show();
                        $('#hideIcon' + key).show();
                        vxgplayer(playerId).stopButton().removeEventListener('click', function(){});
                    });
                }  
            }

            function pauseButton(key) 
            {
                if (isHTTPStream[key])
                {
                    $('#playBtn' + key).fadeIn(500);
                    $('#pauseBtn' + key).fadeOut(500);
                    $('#fullScreenBtn' + key).fadeOut(500);
                    // $('#httpStream' + key).attr('src', 'img/image.jpg');
                    
                    $('#httpStream' + key).fadeOut(500, function() 
                    {
                        $('#httpStream' + key).attr('src', 'img/image.jpg');
                    }.bind(this)).fadeIn(500);
                    
                    playStatus[key] = false;
                }                   
            }

            function showFullScreen(key)
            {
                console.log("Enter Full Screen");
                $('#fullScreenImage').attr('src', $('#httpLink' + key).text());
                $('#myModal').fadeIn();
                inFullScreen = true;
            }

            function exitFullScreen()
            {
                console.log("Exit Full Screen");
                $('#myModal').fadeOut();
                inFullScreen = false;
            }

            window.onclick = function(event) 
            {
                var modal = document.getElementById('myModal');
                if (event.target == modal) 
                {
                    exitFullScreen();
                }
            }

            $(document).keyup(function(event) 
            {
                if ((event.keyCode == 27) && inFullScreen)
                {
                    exitFullScreen();
                }
            });

            function reset()
            {
                $.each(cameras, function(key, val)
                {
                    $('#csview_status' + key).hide();
                    $('#csview_text' + key).removeClass('alert_camera');
                    $('#csview_text' + key).addClass('p_video_change');
                });
            }

            function changeColor(key)
            {
                console.log('Timer on and key is', key);
                $('#csview_text' + key).addClass('alert_camera');
            }

            function onListSelect(id)
            {
                pauseAlarm();
                alerts = [];
                var value = $(id).attr('id')
                $('#contentTitle').text(value);
                floor = value;
                showFilteredCameras(floor);
            }

            function favChange(key)
            {
                console.log(key);
                var val = cameras[key];
                console.log(val);
                console.log(val['favourite']);

                if (val['favourite'] == 0)
                {
                    val['favourite'] = 1;
                    $('#fav' + key).removeClass('favOff');
                    $('#fav' + key).addClass('favOn');
                }
                else
                {
                    val['favourite'] = 0;
                    $('#fav' + key).removeClass('favOn');
                    $('#fav' + key).addClass('favOff');
                }

                console.log(val);
                var jsondata = JSON.stringify(val);
                console.log(jsondata);
                editCamera(jsondata, key);
            }

            function editCamera(jsondata, cameraId)
            {
                $.ajax(
                {
                    url: 'load.php',
                    type: 'POST',
                    data:
                    {
                        reqMethod: 'editCamera',
                        data: jsondata,
                        camera_id: cameraId
                    },
                    dataType: "json",
                    success: function(response)
                    {
                        console.log("Response<br/>");
                        console.log(response);

                        if (response['status'])
                        {               
                            showFilteredCameras(floor);
                        }
                        else
                        {
                            alert("Failed");                          
                        }
                    },
                    error: function()
                    {
                        // alert("Failed establishing communication with the server");
                        window.location = "home";
                    }
                });
            }

            function startTimer()
            {
                setInterval(alertFunc, interval);
            }

            function alertFunc()
            {
                // console.log("alerts " + alerts);
                for (var key in alerts)
                {
                    alerts[key] = alerts[key] + interval;
                    if (alerts[key] >= alertShowTime)
                    {
                        console.log("remove " + key);

                        // Remove
                        if ($("#cview" + key) != undefined)
                        {
                            $('#csview_status' + key).hide();
                            $('#csview_text' + key).removeClass('alert_camera');
                            $('#csview_text' + key).addClass('p_video_change');
                            pauseAlarm();
                            delete alerts[key];
                        }
                    }
                    else
                    {
                        playAlarm();
                    }
                }

                // console.log("alerts " + alerts);

                $.ajax(
                {
                    url: 'load.php',
                    type: 'POST',
                    data:
                    {
                        reqMethod: 'getAlertInfo'
                    },
                    dataType: "json",
                    success: function(response)
                    {
                        // console.log("Response");
                        // console.log(response);
                        $.each(response, function(key, val)
                        {
                            if ($("#cview" + key) != undefined)
                            {
                                alerts[key] = 0;
                                console.log(key);
                                var camera = cameras[key];
                                console.log(camera);
                                if (camera['sound_alarm'] == 1)
                                {
                                    playAlarm();
                                }
                                changeColor(key);
                                console.log(val);
                                for (var i = 0; i < val.length; i++)
                                {
                                    $('#csview_status' + key).show();
                                    $('#csview_status' + key).text(" " + val[i]);
                                }
                            }
                        });
                    },
                    error: function()
                    {
                        // alert("Failed establishing communication with the server");
                        window.location = "home";
                    }
                });
            }

            function alertVideo()
            {
                $('.video_view_g').toggleClass("video_view_r");
            }

            onLoad();
            startTimer();

            function onClickSearch()
            {
                $.each(cameras, function (key, val) 
                {
                    if (vxgplayer('mr_media_player' + key) != undefined)
                    {
                        vxgplayer('mr_media_player' + key).dispose();
                    }
                });

                $('#viewVideo').empty();

                pauseAlarm();
                alerts = [];

                var str = $('#search_input').val();
                str = str.trim();
                var lowerCaseStr = str.toLowerCase();
                var upperCaseStr = str.toUpperCase();
                console.log(str);
                if (str != "")
                {
                    $.each(cameras, function(key, val)
                    {
                        var name = val['camera_name'];
                        console.log(name);
                        if (name.includes(str) || name.includes(lowerCaseStr) || name.includes(upperCaseStr))
                        {
                            //$("#cview"+key).show();
                            addVideoView(key, val);
                            addCameraView(key, val['http_url']);
                        }
                        else
                        {
                            //$("#cview"+key).hide();
                        }

                        if (playStatus[key])
                        {
                            hidePlayButton(key);
                        }
                    });
                }
                else
                {
                    console.log(floor);
                    this.showFilteredCameras(floor);
                }
            }

            function changing(that)
            {
                var colors = document.getElementById('select').value;
                document.getElementById('main').style.backgroundImage = colors;
            }

            function readURL(event)
            {
                var getImagePath = URL.createObjectURL(event.target.files[0]);
                $('#main').css('background-image', 'url(' + getImagePath + ')');
            }

        </script> -->
</head>

<body id="main">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12 div_top_view">
                <div class="col-md-12 input-group search_div">

                    <div class="col-md-3 col-sm-4 col-xs-4">
                        <img src="static/img/Deepsight_AI_Labs.png" alt="DeepSight AI Labs" class="img_style img-responsive">
                    </div>

                    <div class="col-md-9 col-sm-8 col-xs-8" style="margin-top: 8px;">
                        <input id="search_input" type="text" class="form-control search_view" placeholder="Search" name="search">

                        <div class="input-group-btn">
                            <label class="btn" style="padding:0px !important;border:0px !important;">
                                <button onclick='onClickSearch()' class="btn btn_search " type="submit">
                                    <i class="glyphicon glyphicon-search"></i>
                                </button>
                            </label>
                        </div>

                        <select onchange="changeBackgroundImage()" id="select" class="btn_user_list selectpicker" style="width: 100px;">
                            <option value="">Select</option>
                            <option value="Bank.jpeg" id="img" style="padding: 5px; width: 100px;">Bank</option>
                            <option value="Hospital.jpeg" id="img" style="padding: 5px; width: 100px;">Hospital</option>
                            <option value="Insurance.jpeg" id="img2" style="padding: 5px; width: 100px;">Insurance</option>
                            <option value="Pixel.jpeg" id="img3" style="padding: 5px; width: 100px;">Pixel</option>
                            <option value="Retail.jpeg" id="img4" style="padding: 5px; width: 100px;">Retail</option>
                        </select>

                        <button onclick="location.href='home';" class="add_btn float-right btn btn-success button_browse">Home</button>
                        <button onclick="location.href='add';" class="add_btn float-right btn btn-success button_browse">Add Camera</button>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="myModal" class="modal">
        <img id='fullScreenImage' class='modal_content' src=''>
    </div>

    <div class="container-fluid">
        <div class="row">
            <div class="table_div col-md-12 div_content_show main">
                <div class="col-md-2 filter_div checkboxfilter-wrap div_left">
                    <ul class="maim_ul_view" id="filters"></ul>
                </div>
                <div class="content col-md-10 col-sm-12 col-xs-12 div_content_video_outer">
                    <div class="div_content_video">
                        <p id="contentTitle" class="videoHead"></p>
                        <div id="viewVideo"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container-fluid text-center">
            <p>GoDeep Version 1.0 by
                <a class="link-text" href="https://www.deepsightlabs.com">DeepSight AI Labs</a>
            </p>
            <p>&copy; <script>document.write(new Date().getFullYear())</script> | All Rights Reserved</p>
        </div>
    </div>
</body>

</html>